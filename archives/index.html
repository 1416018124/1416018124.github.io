
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hexo">
    <title>Archives - Hexo</title>
    <meta name="author" content="John Doe">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/archives/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-xvfnj2o9xv19zzpzzydweqhvegynmqvndecmgp9x1tqnkjmbbtwsdcdaxggz.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Hexo
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/1416018124"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/12/19/Manually_deploy_k8s/"
                            aria-label=": 手动部署k8s"
                        >
                            手动部署k8s
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-12-19T23:07:17+08:00">
	
		    Dec 19, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="集群初始化安装"><a href="#集群初始化安装" class="headerlink" title="集群初始化安装"></a>集群初始化安装</h1><h1 id="1-拓扑规划："><a href="#1-拓扑规划：" class="headerlink" title="1.拓扑规划："></a>1.拓扑规划：</h1><h2 id="机器规划"><a href="#机器规划" class="headerlink" title="机器规划"></a>机器规划</h2><table>
<thead>
<tr>
<th>hostname</th>
<th>role</th>
<th>ip</th>
<th>配置</th>
<th>OS</th>
<th>deploy software</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-01</td>
<td>master</td>
<td>192.168.3.24</td>
<td>8c-32g</td>
<td>debian12.8</td>
<td>apiserver、controller-manager、scheduler、etcd、kubectl、kubelet、kube-proxy、containerd</td>
</tr>
<tr>
<td>k8s-01</td>
<td>worker</td>
<td>192.168.3.25</td>
<td>8c-32g</td>
<td>debian12.8</td>
<td>kubelet、kube-proxy、containerd</td>
</tr>
<tr>
<td>k8s-01</td>
<td>worker</td>
<td>192.168.3.26</td>
<td>8c-32g</td>
<td>debian12.8</td>
<td>kubelet、kube-proxy、containerd</td>
</tr>
</tbody></table>
<h2 id="网络环境"><a href="#网络环境" class="headerlink" title="网络环境"></a>网络环境</h2><table>
<thead>
<tr>
<th align="left">网段名称</th>
<th align="left">网段CIDR</th>
</tr>
</thead>
<tbody><tr>
<td align="left">节点网段</td>
<td align="left">192.168.3.0&#x2F;24</td>
</tr>
<tr>
<td align="left">pod网段</td>
<td align="left">172.16.0.0&#x2F;16</td>
</tr>
<tr>
<td align="left">service网段</td>
<td align="left">10.96.0.0&#x2F;16</td>
</tr>
</tbody></table>
<h2 id="程序版本"><a href="#程序版本" class="headerlink" title="程序版本"></a>程序版本</h2><table>
<thead>
<tr>
<th align="left">kubernetes程序</th>
<th align="left">程序版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">kubernetes</td>
<td align="left">1.32.0</td>
</tr>
<tr>
<td align="left">etcd</td>
<td align="left">3.5.7</td>
</tr>
<tr>
<td align="left">cfssl</td>
<td align="left">1.6.1</td>
</tr>
<tr>
<td align="left">coredns</td>
<td align="left">1.9.3</td>
</tr>
<tr>
<td align="left">metrics-server</td>
<td align="left">0.6.1</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">基础软件</th>
<th align="left">软件版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">containerd</td>
<td align="left">1.6.19</td>
</tr>
<tr>
<td align="left">runc</td>
<td align="left">1.1.4</td>
</tr>
<tr>
<td align="left">crictl</td>
<td align="left">1.24.1</td>
</tr>
</tbody></table>
<h1 id="2-操作系统设置"><a href="#2-操作系统设置" class="headerlink" title="2.操作系统设置"></a>2.操作系统设置</h1><h3 id="2-1swap设置"><a href="#2-1swap设置" class="headerlink" title="2.1swap设置"></a>2.1swap设置</h3><p>由于k8s不支持swap，我们需要关闭swap:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -ir &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>



<h3 id="2-2-设置hosts解析"><a href="#2-2-设置hosts解析" class="headerlink" title="2.2 设置hosts解析"></a>2.2 设置hosts解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-01:~# cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">127.0.1.1	k8s-01</span><br><span class="line"></span><br><span class="line">192.168.3.24 k8s-01</span><br><span class="line">192.168.3.25 k8s-02</span><br><span class="line">192.168.3.26 k8s-03</span><br></pre></td></tr></table></figure>



<h3 id="2-3安装软件和工具"><a href="#2-3安装软件和工具" class="headerlink" title="2.3安装软件和工具"></a>2.3安装软件和工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install curl iptables containerd vim sudo -y</span><br></pre></td></tr></table></figure>



<h3 id="2-4配置ulimit"><a href="#2-4配置ulimit" class="headerlink" title="2.4配置ulimit"></a>2.4配置ulimit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件句柄</span></span><br><span class="line">ulimit -SHn 65535 &amp;&amp; \</span><br><span class="line">cat &gt; /etc/security/limits.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-5启用ipvs-安装ipvsadmin"><a href="#2-5启用ipvs-安装ipvsadmin" class="headerlink" title="2.5启用ipvs&#x2F;安装ipvsadmin"></a>2.5启用ipvs&#x2F;安装ipvsadmin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> apt-get install ipvsadm ipset sysstat conntrack</span><br><span class="line"> </span><br><span class="line"> cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="2-6启用overlay和br-netfilter"><a href="#2-6启用overlay和br-netfilter" class="headerlink" title="2.6启用overlay和br_netfilter"></a>2.6启用overlay和br_netfilter</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"></span><br><span class="line">lsmod | grep overlay</span><br></pre></td></tr></table></figure>



<h3 id="2-7-修改内核参数"><a href="#2-7-修改内核参数" class="headerlink" title="2.7 修改内核参数"></a>2.7 修改内核参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/95-k8s-sysctl.conf &lt;&lt;EOF </span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line"></span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">vm.max_map_count=655360</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>



<h3 id="安装PKI管理工具-cfssl"><a href="#安装PKI管理工具-cfssl" class="headerlink" title="安装PKI管理工具-cfssl"></a>安装PKI管理工具-cfssl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载cfssl二进制程序</span></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl_1.6.3_linux_amd64 -O /usr/local/bin/cfssl</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssljson_1.6.3_linux_amd64 -O /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加执行权限</span></span><br><span class="line">chmod +x /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>



<h2 id="3-配置containerd"><a href="#3-配置containerd" class="headerlink" title="3.配置containerd"></a>3.配置containerd</h2><h3 id="3-1下载二进制文件"><a href="#3-1下载二进制文件" class="headerlink" title="3.1下载二进制文件"></a>3.1下载二进制文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/containerd/&#123;app,bin,cnibin,config,service&#125;</span><br><span class="line">cd /root/containerd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载二进制文件</span></span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.6.19/cri-containerd-cni-1.6.19-linux-amd64.tar.gz </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar  --wildcards -xf app/cri-containerd-cni-1.6.19-linux-amd64.tar.gz --strip-components=3 -C bin usr/local/bin/&#123;containerd*,crictl,ctr&#125;</span><br><span class="line">tar --wildcards -xf app/containerd.tar.gz --strip-components=3 -C cnibin opt/cni/bin/*</span><br><span class="line"></span><br><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64 -O bin/runc</span><br><span class="line">chmod +x bin/runc</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-2创建containerd服务"><a href="#3-2创建containerd服务" class="headerlink" title="3.2创建containerd服务"></a>3.2创建containerd服务</h3><p>在&#x2F;root&#x2F;containerd 创建以下两个配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat service/containerd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target local-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/local/bin/containerd</span><br><span class="line"></span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> the kernel. We recommend using cgroups to <span class="keyword">do</span> container-local accounting.</span></span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Comment TasksMax <span class="keyword">if</span> your systemd version does not supports it.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Only systemd 226 and above support this version.</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">cat config/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br></pre></td></tr></table></figure>



<h3 id="3-3生成配置文件"><a href="#3-3生成配置文件" class="headerlink" title="3.3生成配置文件"></a>3.3生成配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./bin/containerd config default &gt; config/config.toml</span><br><span class="line">sed -i &#x27;s#root = \&quot;/var/lib/containerd\&quot;#root = \&quot;/data/containerd\&quot;#&#x27; config/config.toml</span><br><span class="line">sed -i &#x27;s#sandbox_image = \&quot;k8s.gcr.io/pause:#sandbox_image = \&quot;registry.aliyuncs.com/google_containers/pause:#&#x27; config/config.toml</span><br><span class="line">sed -i &#x27;s#sandbox_image = \&quot;registry.k8s.io/pause:#sandbox_image = \&quot;registry.aliyuncs.com/google_containers/pause:#&#x27; config/config.toml</span><br><span class="line">sed -i &#x27;s#SystemdCgroup = false#SystemdCgroup = true#&#x27; config/config.toml</span><br></pre></td></tr></table></figure>



<h3 id="3-4分发二进制和配置"><a href="#3-4分发二进制和配置" class="headerlink" title="3.4分发二进制和配置"></a>3.4分发二进制和配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">ssh $i &quot;mkdir -p /etc/containerd&quot;; \</span><br><span class="line">ssh $i &quot;mkdir -p /opt/cni/bin&quot;; \</span><br><span class="line">ssh $i &quot;mkdir -p /opt/containerd&quot;; \</span><br><span class="line">ssh $i &quot;mkdir -p /etc/cni/net.d&quot;; \</span><br><span class="line">scp bin/* $i:/usr/local/bin/; \</span><br><span class="line">scp cnibin/* $i:/opt/cni/bin/; \</span><br><span class="line">scp service/containerd.service $i:/usr/lib/systemd/system/; \</span><br><span class="line">scp config/config.toml $i:/etc/containerd/; \</span><br><span class="line">scp config/containerd.conf $i:/etc/modules-load.d/; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<h3 id="3-5启动服务"><a href="#3-5启动服务" class="headerlink" title="3.5启动服务"></a>3.5启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">ssh $i &quot;systemctl restart systemd-modules-load.service&quot;; \</span><br><span class="line">ssh $i &quot;systemctl daemon-reload&quot;; \</span><br><span class="line">ssh $i &quot;systemctl enable containerd&quot;; \</span><br><span class="line">ssh $i &quot;systemctl restart containerd --no-block&quot;; \</span><br><span class="line">ssh $i &quot;systemctl is-active containerd&quot;; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<h3 id="3-6配置cricti"><a href="#3-6配置cricti" class="headerlink" title="3.6配置cricti"></a>3.6配置cricti</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat config/crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">scp config/crictl.yaml $i:/etc/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<h3 id="3-7国内镜像代理"><a href="#3-7国内镜像代理" class="headerlink" title="3.7国内镜像代理"></a>3.7国内镜像代理</h3><p>在&#x2F;etc&#x2F;containerd&#x2F;config.toml 添加如下配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br><span class="line">      config_path = &quot;&quot;</span><br><span class="line"></span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths]</span><br><span class="line"></span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span><br><span class="line"></span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]</span><br><span class="line"></span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">         endpoint = [&quot;https://docker.m.daocloud.io&quot;]</span><br></pre></td></tr></table></figure>





<h1 id="4-配置etcd"><a href="#4-配置etcd" class="headerlink" title="4 配置etcd"></a>4 配置etcd</h1><h2 id="4-1-下载etcd"><a href="#4-1-下载etcd" class="headerlink" title="4.1 下载etcd"></a>4.1 下载etcd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建保存配置的文件夹</span></span><br><span class="line">mkdir -p /root/etcd/&#123;bin,config,service,ssl,app&#125;</span><br><span class="line">cd /root/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载etcd二进制文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">github二进制包下载地址：https://github.com/etcd-io/etcd/releases</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.7/etcd-v3.5.7-linux-amd64.tar.gz -O app/etcd.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf app/etcd.tar.gz --strip-components=1 -C bin/ etcd-v3.5.7-linux-amd64/etcd&#123;,ctl&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-2-生成CA使用的证书"><a href="#4-2-生成CA使用的证书" class="headerlink" title="4.2 生成CA使用的证书"></a>4.2 生成CA使用的证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat /root/etcd/ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;etcd&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">          &quot;signing&quot;,</span><br><span class="line">          &quot;key encipherment&quot;,</span><br><span class="line">          &quot;server auth&quot;,</span><br><span class="line">	  &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat /root/etcd/ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;feng&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;etcd&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>生成ca证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/etcd</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ssl/ca</span><br></pre></td></tr></table></figure>



<h2 id="4-3生成etcd-server端证书"><a href="#4-3生成etcd-server端证书" class="headerlink" title="4.3生成etcd server端证书"></a>4.3生成etcd server端证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat /root/etcd/server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.3.24&quot;,</span><br><span class="line">    &quot;192.168.3.25&quot;,</span><br><span class="line">    &quot;192.168.3.26&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">	    &quot;O&quot;: &quot;feng&quot;,</span><br><span class="line">	    &quot;OU&quot;: &quot;etcd&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成etcd使用的证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/etcd/</span><br><span class="line">cfssl gencert -ca=ssl/ca.pem -ca-key=ssl/ca-key.pem -config=ca-config.json -profile=etcd server-csr.json | cfssljson -bare ssl/server</span><br></pre></td></tr></table></figure>

<p>此时的证书文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tree ssl/</span><br><span class="line">ssl/</span><br><span class="line">|-- ca-key.pem</span><br><span class="line">|-- ca.csr</span><br><span class="line">|-- ca.pem</span><br><span class="line">|-- server-key.pem</span><br><span class="line">|-- server.csr</span><br><span class="line">`-- server.pem</span><br></pre></td></tr></table></figure>

<p>将证书文件发放到所有设备上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">    scp ssl/* $i:/opt/etcd/ssl/; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<h2 id="4-4生成etcd配置文件"><a href="#4-4生成etcd配置文件" class="headerlink" title="4.4生成etcd配置文件"></a>4.4生成etcd配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/etcd/config/etcd.config.yaml</span><br><span class="line">name: &#x27;k8s-01&#x27;</span><br><span class="line">data-dir: /opt/etcd/data</span><br><span class="line">wal-dir: /opt/etcd/data/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.3.24:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.3.24:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.3.24:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.3.24:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">initial-cluster: &#x27;k8s-01=https://192.168.3.24:2380,k8s-02=https://192.168.3.25:2380,k8s-03=https://192.168.3.26:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-cluster&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">init <span class="built_in">set</span> new, restart again <span class="built_in">set</span> existing</span></span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/opt/etcd/ssl/server.pem&#x27;</span><br><span class="line">  key-file: &#x27;/opt/etcd/ssl/server-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/opt/etcd/ssl/ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/opt/etcd/ssl/server.pem&#x27;</span><br><span class="line">  key-file: &#x27;/opt/etcd/ssl/server-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/opt/etcd/ssl/ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br></pre></td></tr></table></figure>

<p>其他两个配置同上，修改name 为主机名，将k8s-01的IP改为当前设备的IP</p>
<h2 id="4-5-配置systemd启动"><a href="#4-5-配置systemd启动" class="headerlink" title="4.5 配置systemd启动"></a>4.5 配置systemd启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat /lib/systemd/system/etcd.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">--config-file=/opt/etcd/config/etcd.config.yaml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br></pre></td></tr></table></figure>

<p><code>systemctl start etcd; systemctl enable etcd</code></p>
<h2 id="4-6-启动etcd"><a href="#4-6-启动etcd" class="headerlink" title="4.6 启动etcd"></a>4.6 启动etcd</h2><h3 id="清除旧数据"><a href="#清除旧数据" class="headerlink" title="清除旧数据"></a>清除旧数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /opt/etcd/data/*</span><br></pre></td></tr></table></figure>



<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl start etcd &amp;&amp; systemctl status etcd</span><br></pre></td></tr></table></figure>



<h2 id="4-7-验证etcd"><a href="#4-7-验证etcd" class="headerlink" title="4.7 验证etcd"></a>4.7 验证etcd</h2><p>查看集群健康状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl endpoint health</span><br><span class="line"></span><br><span class="line">127.0.0.1:2379 is healthy: successfully committed proposal: took = 5.869908ms</span><br></pre></td></tr></table></figure>



<p>查看集群成员：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl member list</span><br><span class="line">48a815da8dbb8608, started, k8s-02, https://192.168.3.25:2380, https://192.168.3.25:2379, false</span><br><span class="line">c0b978d1e0738f2e, started, k8s-03, https://192.168.3.26:2380, https://192.168.3.26:2379, false</span><br><span class="line">ea085da21158e6dc, started, k8s-01, https://192.168.3.24:2380, https://192.168.3.24:2379, false</span><br></pre></td></tr></table></figure>

<p>写操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl put hello world</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>读操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl get hello</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>



<p>命令中加入证书配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> etcdctl --endpoints=https://192.168.3.24:2379 --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem member list</span><br><span class="line">48a815da8dbb8608, started, k8s-02, https://192.168.3.25:2380, https://192.168.3.25:2379, false</span><br><span class="line">c0b978d1e0738f2e, started, k8s-03, https://192.168.3.26:2380, https://192.168.3.26:2379, false</span><br><span class="line">ea085da21158e6dc, started, k8s-01, https://192.168.3.24:2380, https://192.168.3.24:2379, false</span><br></pre></td></tr></table></figure>



<h1 id="5-部署k8s组件"><a href="#5-部署k8s组件" class="headerlink" title="5 部署k8s组件"></a>5 部署k8s组件</h1><h2 id="5-1-下载二进制包"><a href="#5-1-下载二进制包" class="headerlink" title="5.1 下载二进制包"></a>5.1 下载二进制包</h2><p>在master节点部署3个服务</p>
<ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
</ul>
<p>下载二进制：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.32.md">传送门</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置目录</span></span><br><span class="line">mkdir -p /root/k8s/&#123;app,ssl,config,service,bin,kubeconfig&#125;</span><br><span class="line">cd /root/k8s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载kubernets二进制包，按版本直接修改v1.26.2 -&gt; v1.xx.x</span></span><br><span class="line">wget https://dl.k8s.io/v1.26.2/kubernetes-server-linux-amd64.tar.gz -O app/kubernetes-server.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -xf app/kubernetes-server.tar.gz  --strip-components=3 -C \</span><br><span class="line">	bin \</span><br><span class="line">        kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-2生成k8s的ca证书"><a href="#5-2生成k8s的ca证书" class="headerlink" title="5.2生成k8s的ca证书"></a>5.2生成k8s的ca证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cat ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ssl/ca</code></p>
<h2 id="5-3部署apiserver"><a href="#5-3部署apiserver" class="headerlink" title="5.3部署apiserver"></a>5.3部署apiserver</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat kube-apiserver-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ssl/ca.pem -ca-key=ssl/ca-key.pem -config=ca-config.json \</span><br><span class="line">	-hostname=127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,10.96.0.1,192.168.3.24 \</span><br><span class="line">	-profile=peer kube-apiserver-csr.json | cfssljson -bare ssl/kube-apiserver</span><br></pre></td></tr></table></figure>



<p>生成CA签名请求文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat front-proxy-ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cat front-proxy-client-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;front-proxy-client&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare ssl/front-proxy-ca</span><br><span class="line">cfssl gencert -ca=ssl/front-proxy-ca.pem -ca-key=ssl/front-proxy-ca-key.pem -config=ca-config.json \</span><br><span class="line">	-profile=peer front-proxy-client-csr.json | cfssljson -bare ssl/front-proxy-client</span><br><span class="line">openssl genrsa -out ssl/sa.key 2048</span><br><span class="line">openssl rsa -in ssl/sa.key -pubout -out ssl/sa.pub</span><br></pre></td></tr></table></figure>



<p>分发二进制文件、证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp bin/kube-apiserver  /usr/local/bin/</span><br><span class="line">cp -r ssl/&#123;kube*.pem,ca&#123;,-key&#125;.pem,front-proxy-client*.pem,front-proxy-ca.pem,sa.*&#125; $i:/opt/k8s/ssl/;</span><br></pre></td></tr></table></figure>



<p>配置systemd文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat /lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">--v=2 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--bind-address=192.168.3.24 \</span><br><span class="line">--advertise-address=192.168.3.24 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/16 --service-node-port-range=30000-32767 \</span><br><span class="line">--etcd-servers=https://192.168.3.24:2379 \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/opt/k8s/ssl/ca.pem \</span><br><span class="line">--tls-cert-file=/opt/k8s/ssl/kube-apiserver.pem \</span><br><span class="line">--tls-private-key-file=/opt/k8s/ssl/kube-apiserver-key.pem \</span><br><span class="line">--kubelet-client-certificate=/opt/k8s/ssl/kube-apiserver.pem \</span><br><span class="line">--kubelet-client-key=/opt/k8s/ssl/kube-apiserver-key.pem \</span><br><span class="line">--service-account-key-file=/opt/k8s/ssl/sa.pub \</span><br><span class="line">--service-account-signing-key-file=/opt/k8s/ssl/sa.key \</span><br><span class="line">--service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \</span><br><span class="line">--authorization-mode=Node,RBAC \</span><br><span class="line">--enable-bootstrap-token-auth=true \</span><br><span class="line">--enable-aggregator-routing=true \</span><br><span class="line">--proxy-client-cert-file=/opt/k8s/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/opt/k8s/ssl/front-proxy-client-key.pem \</span><br><span class="line">--requestheader-client-ca-file=/opt/k8s/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-allowed-names=front-proxy-client \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-username-headers=X-Remote-User</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">--token-auth-file=<span class="variable">$&#123;K8S_CONF_DIR&#125;</span>/token.csv 这里禁用token文件进行认证</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>



<p>启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl restart kube-apiserver --no-block</span><br><span class="line">systemctl is-active kube-apiserver</span><br></pre></td></tr></table></figure>



<h2 id="5-4部署kubectl"><a href="#5-4部署kubectl" class="headerlink" title="5.4部署kubectl"></a>5.4部署kubectl</h2><p>生成kubectl 所需的证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /root/k8s</span><br><span class="line">cat  kubectl-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;clusteradmin&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Hubei&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Wuhan&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ssl/ca.pem -ca-key=ssl/ca-key.pem -config=ca-config.json -profile=peer kubectl-csr.json | cfssljson -bare ssl/kubectl</span><br></pre></td></tr></table></figure>



<p>生成kubeconfig文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat kubeconfig_kubectl_config.sh</span><br><span class="line">APISERVER_IP=$1</span><br><span class="line">K8S_CERT_DIR=$2</span><br><span class="line">PORT=6443</span><br><span class="line">KUBE_APISERVER=https://$&#123;APISERVER_IP&#125;:$&#123;PORT&#125;</span><br><span class="line">CLUSTER_NAME=kubernetes</span><br><span class="line">USERNAME=clusteradmin</span><br><span class="line">KUBECONFIG_FILE=kubeconfig/kubectl.kubeconfig</span><br><span class="line">CONTEXT_NAME=$&#123;USERNAME&#125;@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">CERT_PRFIX=kubectl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">./bin/kubectl config set-cluster $&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --certificate-authority=$&#123;K8S_CERT_DIR&#125;/ca.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置客户端认证参数</span></span><br><span class="line">./bin/kubectl config set-credentials $&#123;USERNAME&#125; \</span><br><span class="line">	--client-certificate=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;.pem \</span><br><span class="line">	--client-key=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;-key.pem \</span><br><span class="line">	--embed-certs=true \</span><br><span class="line">	--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置context---将用户和集群关联起来</span></span><br><span class="line">./bin/kubectl config set-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --cluster=$&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --user=$&#123;USERNAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认contexts</span></span><br><span class="line">./bin/kubectl config use-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-------执行命令</span></span><br><span class="line">bash -x kubeconfig_kubectl_config.sh $192.168.3.24 ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分发kubeconfig文件</span></span><br><span class="line">mkdir -p $HOME/.kube/</span><br><span class="line">cp bin/kubectl /usr/local/bin/</span><br><span class="line">cp kubeconfig/kubectl.kubeconfig $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">kubectl命令补全功能</span></span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>



<p>查看集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kubernetes control plane is running at https://172.15.110.188:6443</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.</span></span></span><br><span class="line"></span><br><span class="line">kubectl get componentstatus</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME                 STATUS      MESSAGE                                                                                        <span class="comment"># ERROR</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scheduler            Unhealthy   Get <span class="string">&quot;https://127.0.0.1:10259/healthz&quot;</span>: dial tcp 127.0.0.1:10259: connect: connection refused</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">controller-manager   Unhealthy   Get <span class="string">&quot;https://127.0.0.1:10257/healthz&quot;</span>: dial tcp 127.0.0.1:10257: connect: connection refused</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcd-0               Healthy     &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span></span><br><span class="line"></span><br><span class="line">kubectl get all -A</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default     service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17m</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="5-5部署controller-manager"><a href="#5-5部署controller-manager" class="headerlink" title="5.5部署controller-manager"></a>5.5部署controller-manager</h2><p>生成controller-manager所需证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat kube-controller-manager-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ssl/ca.pem -ca-key=ssl/ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-hostname=127.0.0.1,192.168.3.24 \</span><br><span class="line">-profile=peer kube-controller-manager-csr.json | cfssljson -bare ssl/kube-controller-manager</span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat kubeconfig_kube-controller-manager.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">APISERVER_IP=$1</span><br><span class="line">K8S_CERT_DIR=$2</span><br><span class="line">PORT=6443</span><br><span class="line">KUBE_APISERVER=https://$&#123;APISERVER_IP&#125;:$&#123;PORT&#125;</span><br><span class="line">KUBECONFIG_FILE=kubeconfig/kube-controller-manager.kubeconfig</span><br><span class="line">CLUSTER_NAME=kubernetes</span><br><span class="line">USERNAME=system:kube-controller-manager</span><br><span class="line">CONTEXT_NAME=$&#123;USERNAME&#125;@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">CERT_PRFIX=kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">./bin/kubectl config set-cluster $&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --certificate-authority=$&#123;K8S_CERT_DIR&#125;/ca.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置用户认证参数</span></span><br><span class="line">./bin/kubectl config set-credentials $&#123;USERNAME&#125; \</span><br><span class="line">	--client-certificate=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;.pem \</span><br><span class="line">	--client-key=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;-key.pem \</span><br><span class="line">	--embed-certs=true \</span><br><span class="line">	--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置context---将用户和集群关联起来</span></span><br><span class="line">./bin/kubectl config set-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --cluster=$&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --user=$&#123;USERNAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认context</span></span><br><span class="line">./bin/kubectl config use-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------执行命令</span></span><br><span class="line">bash -x kubeconfig_kube-controller-manager.sh 192.168.3.24 ssl</span><br><span class="line">mkdir -p /opt/k8s/&#123;ssl,config</span><br><span class="line">cp bin/kube-controller-manager  /usr/local/bin/</span><br><span class="line">cp ssl/kube-controller*.pem $i:/opt/k8s/ssl/</span><br><span class="line">cp kubeconfig/kube-controller-manager.kubeconfig /opt/k8s/config/</span><br></pre></td></tr></table></figure>



<p>systemd配置文件&amp;启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> cat /lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \</span><br><span class="line">--v=2 \</span><br><span class="line">--bind-address=127.0.0.1 \</span><br><span class="line">--root-ca-file=/opt/k8s/ssl/ca.pem \</span><br><span class="line">--cluster-signing-cert-file=/opt/k8s/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/opt/k8s/ssl/ca-key.pem \</span><br><span class="line">--service-account-private-key-file=/opt/k8s/ssl/sa.key \</span><br><span class="line">--tls-cert-file=/opt/k8s/ssl/kube-controller-manager.pem \</span><br><span class="line">--tls-private-key-file=/opt/k8s/ssl/kube-controller-manager-key.pem \</span><br><span class="line">--kubeconfig=/opt/k8s/config/kube-controller-manager.kubeconfig \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--use-service-account-credentials=true \</span><br><span class="line">--node-monitor-grace-period=40s \</span><br><span class="line">--node-monitor-period=5s \</span><br><span class="line">--controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">--allocate-node-cidrs=true \</span><br><span class="line">--cluster-cidr=172.16.0.0/16 \</span><br><span class="line">--requestheader-client-ca-file=/opt/k8s/ssl/front-proxy-ca.pem \</span><br><span class="line">--node-cidr-mask-size=24</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------执行命令</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl restart kube-controller-manager --no-block</span><br><span class="line">systemctl is-active kube-controller-manager</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tlp | grep kube-controller</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LISTEN 0      16384       127.0.0.1:10257             0.0.0.0:*    <span class="built_in">users</span>:((&quot;kube-controller&quot;,pid=<span class="number">2864</span>,fd=<span class="number">7</span>))</span></span><br></pre></td></tr></table></figure>



<h2 id="5-6部署kube-scheduler组件"><a href="#5-6部署kube-scheduler组件" class="headerlink" title="5.6部署kube-scheduler组件"></a>5.6部署kube-scheduler组件</h2><p>生成kube-scheduler所需证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat gen_schduler_cert.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kube-scheduler 的证书和私钥</span></span><br><span class="line">SCHEDULER_IP=$1</span><br><span class="line">CSR_NAME_PREFIX=kube-scheduler</span><br><span class="line"></span><br><span class="line">cat &gt; $&#123;CSR_NAME_PREFIX&#125;-csr.json &lt;&lt;EOF1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF1</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ssl/ca.pem -ca-key=ssl/ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-hostname=$&#123;SCHEDULER_IP&#125; \</span><br><span class="line">-profile=peer $&#123;CSR_NAME_PREFIX&#125;-csr.json | cfssljson -bare ssl/$&#123;CSR_NAME_PREFIX&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash -x gen_schduler_cert.sh 127.0.0.1,192.168.3.24</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在ssl目录下生成</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">├── kube-scheduler-key.pem</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">├── kube-scheduler.pem</span></span><br></pre></td></tr></table></figure>





<p>生成kubeconfig文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat kubeconfig_kube-scheduler.sh</span><br><span class="line"></span><br><span class="line">APISERVER_IP=$1</span><br><span class="line">K8S_CERT_DIR=$2</span><br><span class="line">PORT=6443</span><br><span class="line">KUBE_APISERVER=https://$&#123;APISERVER_IP&#125;:$&#123;PORT&#125;</span><br><span class="line">KUBECONFIG_FILE=kubeconfig/kube-scheduler.kubeconfig</span><br><span class="line">CLUSTER_NAME=kubernetes</span><br><span class="line">USERNAME=system:kube-scheduler</span><br><span class="line">CONTEXT_NAME=$&#123;USERNAME&#125;@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">CERT_PRFIX=kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">./bin/kubectl config set-cluster $&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --certificate-authority=$&#123;K8S_CERT_DIR&#125;/ca.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置用户认证参数</span></span><br><span class="line">./bin/kubectl config set-credentials $&#123;USERNAME&#125; \</span><br><span class="line">	--client-certificate=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;.pem \</span><br><span class="line">	--client-key=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;-key.pem \</span><br><span class="line">	--embed-certs=true \</span><br><span class="line">	--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置context---将用户和集群关联起来</span></span><br><span class="line">./bin/kubectl config set-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --cluster=$&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --user=$&#123;USERNAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认context</span></span><br><span class="line">./bin/kubectl config use-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br></pre></td></tr></table></figure>



<p>运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash -x kubeconfig_kube-scheduler.sh 192.168.3.24 ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 在kubeconfig目录下生成</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">├── kube-scheduler.kubeconfig</span></span><br></pre></td></tr></table></figure>





<p>分发二进制文件、证书、kubeconfig文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/k8s/&#123;ssl,config&#125;</span><br><span class="line">cp bin/kube-scheduler /usr/local/bin/</span><br><span class="line">cp ssl/kube-scheduler*.pem $i:/opt/k8s/ssl/</span><br><span class="line">cp kubeconfig/kube-scheduler.kubeconfig /opt/k8s/config/</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>service文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat /lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \</span><br><span class="line">--v=2 \</span><br><span class="line">--bind-address=127.0.0.1 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--kubeconfig=/opt/k8s/config/kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------执行命令</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl restart kube-scheduler --no-block</span><br><span class="line">systemctl is-active kube-scheduler</span><br></pre></td></tr></table></figure>



<p>验证集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE   ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   ok</span><br></pre></td></tr></table></figure>

<p>至此master节点三大组件部署完毕.</p>
<h1 id="6-部署kubelet"><a href="#6-部署kubelet" class="headerlink" title="6.部署kubelet"></a>6.部署kubelet</h1><h2 id="6-1配置TLS-Bootstrap-手动"><a href="#6-1配置TLS-Bootstrap-手动" class="headerlink" title="6.1配置TLS Bootstrap(手动)"></a>6.1配置TLS Bootstrap(手动)</h2><p>为什么这个证书不是手动管理？因为k8s的master节点可能是固定的，创建好之后一直就是那几台，但worker节点可能变化比较多，如果添加，删除，故障维护时手动添加会比较麻烦，证书和主机名是有绑定的，而我们的主机名又是不一样的，所以需要有一种机制自动颁发证书请求。</p>
<p>每个节点的kubelet组件都要使用由apiserver 使用的CA签发的有效证书才能与apiserver通讯；此时如果节点多起来，为每个节点单独签署证书将是一件非常繁琐的事情；TLS bootstrapping功能就是让kubelet先使用一个预定的低权限用户连接到 apiserver，然后向apiserver申请证书，kubelet的证书由apiserver动态签署。</p>
<p>生成kubeconfig文件：</p>
<p>bootstrap.kubeconfig文件是一个用来向apiserver申请证书的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat kubeconfig_bootstrap_config.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APISERVER_IP=$1</span><br><span class="line">K8S_CERT_DIR=$2</span><br><span class="line">K8S_CONF_DIR=/opt/k8s/config</span><br><span class="line">PORT=6443</span><br><span class="line">KUBE_APISERVER=https://$&#123;APISERVER_IP&#125;:$&#123;PORT&#125;</span><br><span class="line">KUBECONFIG_FILE=kubeconfig/bootstrap.kubeconfig</span><br><span class="line">CLUSTER_NAME=kubernetes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成bootstrap的token</span></span><br><span class="line">TOKEN_ID=$(openssl rand -hex 3)</span><br><span class="line">TOKEN_SECRET=$(openssl rand -hex 8)</span><br><span class="line">BOOTSTRAP_TOKEN=$&#123;TOKEN_ID&#125;.$&#123;TOKEN_SECRET&#125;</span><br><span class="line"></span><br><span class="line">USERNAME=system:bootstrap:$&#123;TOKEN_ID&#125;</span><br><span class="line">CONTEXT_NAME=$&#123;USERNAME&#125;@$&#123;CLUSTER_NAME&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建bootstrap.kubeconfig</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">./bin/kubectl config set-cluster $&#123;CLUSTER_NAME&#125; \</span><br><span class="line">--certificate-authority=$&#123;K8S_CERT_DIR&#125;/ca.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置客户端认证参数，kubelet 使用bootstrap token认证</span></span><br><span class="line">./bin/kubectl config set-credentials $&#123;USERNAME&#125; \</span><br><span class="line">--token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置上下文参数</span></span><br><span class="line">./bin/kubectl config set-context $&#123;CONTEXT_NAME&#125;  \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=$&#123;USERNAME&#125; \</span><br><span class="line">--kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用上下文参数生成 bootstrap.kubeconfig 文件</span></span><br><span class="line">./bin/kubectl config use-context $&#123;CONTEXT_NAME&#125; --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建boostrap token secret</span></span><br><span class="line">cat &gt; config/bootstrap-token-secret.yaml &lt;&lt;EOF1</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: bootstrap-token-$&#123;TOKEN_ID&#125;</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  token-id: $&#123;TOKEN_ID&#125;</span><br><span class="line">  token-secret: $&#123;TOKEN_SECRET&#125;</span><br><span class="line">  usage-bootstrap-authentication: &quot;true&quot;</span><br><span class="line">  usage-bootstrap-signing: &quot;true&quot;</span><br><span class="line">  auth-extra-groups: system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress</span><br><span class="line">EOF1</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash -x kubeconfig_bootstrap_config.sh 192.168.3.24 ssl</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">导入bootstrap-token-secret</span></span><br><span class="line">kubectl apply -f config/bootstrap-token-secret.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看bootstrap-token</span></span><br><span class="line">kubectl get secret -nkube-system</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">NAME                     TYPE                            DATA   AGE</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">bootstrap-token-cb7059   bootstrap.kubernetes.io/token   5      5h44m</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>生成kubelet配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">cat kubelet_config.sh</span><br><span class="line"> cat kubelet_config.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">K8S_CONF_DIR=/opt/k8s/config</span><br><span class="line">K8S_CERT_DIR=/opt/k8s/ssl</span><br><span class="line">CLUSTER_DNS=10.96.0.10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成kubelet参数文件</span></span><br><span class="line">cat &gt; config/kubelet.conf &lt;&lt;EOF1</span><br><span class="line">KUBELET_OPTS=&quot;--v=4 \\</span><br><span class="line">--container-runtime-endpoint=unix:///run/containerd/containerd.sock \\</span><br><span class="line">--runtime-cgroups=/systemd/system.slice \\</span><br><span class="line">--kubeconfig=$&#123;K8S_CONF_DIR&#125;/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=$&#123;K8S_CONF_DIR&#125;/bootstrap.kubeconfig \\</span><br><span class="line">--config=$&#123;K8S_CONF_DIR&#125;/kubelet.yaml \\</span><br><span class="line">--cert-dir=$&#123;K8S_CERT_DIR&#125; \\</span><br><span class="line">--node-labels=node.kubernetes.io/node=&quot;</span><br><span class="line">EOF1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成kubelet配置yaml文件</span></span><br><span class="line">cat &gt; config/kubelet.yaml &lt;&lt;EOF2</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: $&#123;K8S_CERT_DIR&#125;/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">runtimeRequestTimeout: 15m</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- $&#123;CLUSTER_DNS&#125;</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">EOF2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成kubelet.service服务启动文件</span></span><br><span class="line">cat &gt; service/kubelet.service &lt;&lt;EOF3</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=containerd.service</span><br><span class="line">Requires=containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/hugetlb/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/blkio/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/cpuset/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/devices/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/net_cls,net_prio/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/perf_event/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/cpu,cpuacct/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/freezer/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/memory/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/pids/systemd/system.slice</span><br><span class="line">ExecStartPre=-/bin/mkdir -p /sys/fs/cgroup/systemd/systemd/system.slice</span><br><span class="line">LimitNOFILE=655350</span><br><span class="line">LimitNPROC=655350</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在centos系统上需要配置CPUAccounting和MemoryAccounting</span></span><br><span class="line">CPUAccounting=true</span><br><span class="line">MemoryAccounting=true</span><br><span class="line">EnvironmentFile=$&#123;K8S_CONF_DIR&#125;/kubelet.conf</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \$KUBELET_OPTS</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF3</span><br></pre></td></tr></table></figure>



<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash -x kubelet_config.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分发二进制文件、配置文件、证书、kuconfig文件及service文件</span></span><br><span class="line">mkdir -p /opt/k8s/&#123;config,ssl,manifests&#125;</span><br><span class="line">cp bin/kubelet $i:/usr/local/bin/</span><br><span class="line">cp config/kubelet.&#123;conf,yaml&#125; $i:/opt/k8s/config/</span><br><span class="line">cp kubeconfig/bootstrap.kubeconfig $i:/opt/k8s/config/</span><br><span class="line">cp ssl/ca.pem $i:/opt/k8s/ssl</span><br><span class="line">cp service/kubelet.service $i:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>



<p>使用<code>systemctl status kubelet</code>会发现kubelet启动失败，进一步使用<code>journalctl -xe -u kubelet.service --no-pager | less</code>会发现如下错误，提示<code>User &quot;system:bootstrap:a0da46&quot;</code>不能创建资源<code>certificatesigningrequests</code></p>
<p>在默认情况下，kubelet 通过 <code>bootstrap.kubeconfig</code> 中的预设用户<code>Token</code>声明了自己的身份，然后创建 CSR 请求；但是这个用户默认没有任何权限的，包括创建 CSR 请求；所以需要授权如下命令创建一个 ClusterRoleBinding，将预设用户 <code>kubelet-bootstrap</code> 与内置的 ClusterRole <code>system:node-bootstrapper</code> 绑定到一起，使其能够发起 CSR 请求</p>
<p>在使用 Bootstrap Token 进行引导时，Kubelet 组件使用 Token 发起的请求其用户名为<code>system:bootstrap:&lt;tokenid&gt;</code>，所属组为<code>system:bootstrappers</code>，然后创建CSR请求，但是此用户没有任何权限；在k8s中已经创建了一个clusterrole（system:node-bootstrapper），此集群角色具有发起CSR请求的权限，我们需要创建一个clusterrolebinding将clusterrole和此token的用户名或者所属组进行关联，然后<code>system:bootstrap:&lt;tokenid&gt;</code>拥有了<code>system:node-bootstrapper</code>的权限，这样任何用户拿着这个token连接apiserver都具有<code>system:node-bootstrapper</code>的权限</p>
<p>这里创建一个clusterrolebinding（create-csrs-for-bootstrapping）将clusterrole和group进行绑定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping \</span><br><span class="line">        --clusterrole=system:node-bootstrapper \</span><br><span class="line">        --group=system:bootstrappers:default-node-token </span><br><span class="line"></span><br><span class="line">kubectl get clusterrolebinding create-csrs-for-bootstrapping</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME                            ROLE                                   AGE</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create-csrs-for-bootstrapping   ClusterRole/system:node-bootstrapper   22s</span></span><br></pre></td></tr></table></figure>





<p>手动签发kubelt证书</p>
<p>任何人使用token进行认证通过后进入授权阶段，api-server从该token中获取namespace和name信息,并将该token特殊对待，授予anyone bootstrap权利，将该匿名用户划分到system:bootstraps组，至此anyone使用该token认证的时候都具有了system:node-bootstrapper的权利</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看节点kubelet启动证书请求状态，这时已经是Pending状态</span></span><br><span class="line">kubectl get csr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR                 REQUESTEDDURATION   CONDITION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node-csr-Rd0Mxw-GPHt5p66qLCnLWUxj0g7uWUDtiNS0UjVafb8   4s    kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:a0da46   &lt;none&gt;              Pending</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动签发kubelet的证书</span></span><br><span class="line">kubectl certificate approve $(kubectl get csr | grep node | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">certificatesigningrequest.certificates.k8s.io/node-csr-Rd0Mxw-GPHt5p66qLCnLWUxj0g7uWUDtiNS0UjVafb8 approved</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次查看证书请求状态，已经变成了Approved,Issued</span></span><br><span class="line">kubectl get csr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR                 REQUESTEDDURATION   CONDITION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node-csr-Rd0Mxw-GPHt5p66qLCnLWUxj0g7uWUDtiNS0UjVafb8   2m48s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:a0da46   &lt;none&gt;              Approved,Issued</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看node，由于网络插件还未安装，状态显示为NotReady</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME   STATUS     ROLES    AGE   VERSION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k8s-01    NotReady   &lt;none&gt;   79s   v1.32.0-rc.2</span></span><br></pre></td></tr></table></figure>



<h2 id="6-2自动批准，自动续期，自动颁发"><a href="#6-2自动批准，自动续期，自动颁发" class="headerlink" title="6.2自动批准，自动续期，自动颁发"></a>6.2自动批准，自动续期，自动颁发</h2><p>要是有很多worker节点要安装kubelet，手工去approve证书请求会很繁琐，增加工作量，就有了自动批准，自动续期，自动颁发的方法。</p>
<p>kubelet所发起的CSR请求是由controller manager签署的；如果想要是实现自动续期，就需要让controller manager能够在 kubelet发起证书请求的时候自动帮助其签署证书；那么controller manager不可能对所有的CSR证书申请都自动签署，这时候就需要配置RBAC规则，保证controller manager只对kubelet发起的特定CSR请求自动批准即可；在TLS bootstrapping官方文档中，CSR有三种请求类型:</p>
<ul>
<li>nodeclient: kubelet以O&#x3D;system:nodes和CN&#x3D;system:node:(node name)形式发起的CSR请求</li>
<li>selfnodeclient: kubelet client renew自己的证书发起的CSR请求(与上一个证书就有相同的O和CN)</li>
<li>selfnodeserver: kubelet server renew 自己的证书发起的CSR请求</li>
</ul>
<p>通俗点讲就是: nodeclient类型的CSR仅在第一次启动时会产生，selfnodeclient类型的CSR请求实际上就是kubelet renew自己作为client跟 apiserver通讯时使用的证书产生的，selfnodeserver类型的CSR请求则是kubelet首次申请或后续renew自己的10250 api端口证书时产生的，以下为3中CSR请求分别创建3种对应的Clusterrole</p>
<p>创建3个clusterrolebinding</p>
<ul>
<li>自动批准kubelet首次用于与 apiserver 通讯证书的 CSR 请求(nodeclient)</li>
<li>自动批准kubelet首次用于10250端口鉴权的CSR请求(实际上这个请求走的也是 selfnodeserver 类型 CSR)</li>
<li>自动批准kubelet后续renew用于与apiserver通讯证书的 CSR 请求(selfnodeclient)</li>
<li>自动批准kubelet后续renew用于10250端口鉴权的 CSR 请求(selfnodeserver)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动批准 kubelet 的首次 CSR 请求(用于与 apiserver 通讯的证书)</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --group=system:bootstrappers</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动批准 kubelet 后续 renew 用于与 apiserver 通讯证书的 CSR 请求</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动批准 kubelet 发起的用于 10250 端口鉴权证书的 CSR 请求(包括后续 renew)</span></span><br><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes</span><br></pre></td></tr></table></figure>





<p>分发二进制文件、配置文件、证书、kuconfig文件及service文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分发到k8s-02和k8s-03</span></span><br><span class="line">for i in k8s-02 k8s-03; do \</span><br><span class="line">ssh $i &quot;mkdir -p /opt/k8s/&#123;config,ssl,manifests&#125;&quot;; \</span><br><span class="line">scp bin/kubelet $i:/usr/local/bin/; \</span><br><span class="line">scp config/kubelet.&#123;conf,yaml&#125; $i:/opt/k8s/config/; \</span><br><span class="line">scp kubeconfig/bootstrap.kubeconfig $i:/opt/k8s/config/; \</span><br><span class="line">scp ssl/ca.pem $i:/opt/k8s/ssl; \</span><br><span class="line">scp service/kubelet.service $i:/usr/lib/systemd/system/; \</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for i in k8s-02 k8s-03; do \</span><br><span class="line">ssh $i &quot;systemctl daemon-reload&quot;; \</span><br><span class="line">ssh $i &quot;systemctl enable kubelet&quot;; \</span><br><span class="line">ssh $i &quot;systemctl restart kubelet --no-block&quot;; \</span><br><span class="line">ssh $i &quot;systemctl is-active kubelet&quot;; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>查看csr和集群信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次查看所有节点已经自己申请证书并自动批准，颁发</span></span><br><span class="line">kubectl get csr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR                 REQUESTEDDURATION   CONDITION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node-csr-Rd0Mxw-GPHt5p66qLCnLWUxj0g7uWUDtiNS0UjVafb8   10m   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:a0da46   &lt;none&gt;              Approved,Issued</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node-csr-ZOEo99khFzaWWKmYTHn8DctSmnvyngGG-DLr7q-wIZo   13s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:a0da46   &lt;none&gt;              Approved,Issued</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node-csr-fO2nU2tQC9RjwRyvZ6aA2338yWzgA43UZr0ka79rO8A   11s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:a0da46   &lt;none&gt;              Approved,Issued</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME   STATUS     ROLES    AGE     VERSION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">m01    NotReady   &lt;none&gt;   9m29s   v1.26.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">w01    NotReady   &lt;none&gt;   77s     v1.26.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">w02    NotReady   &lt;none&gt;   75s     v1.26.2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改node的role标签</span></span><br><span class="line">kubectl label nodes m01 node-role.kubernetes.io/master=</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node/m01 labeled</span></span><br><span class="line"></span><br><span class="line">kubectl label nodes w01 node-role.kubernetes.io/worker=</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node/w01 labeled</span></span><br><span class="line"></span><br><span class="line">kubectl label nodes w02 node-role.kubernetes.io/worker=</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node/w02 labeled</span></span><br><span class="line"></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME   STATUS     ROLES    AGE    VERSION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">m01    NotReady   master   10m    v1.26.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">w01    NotReady   worker   2m1s   v1.26.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">w02    NotReady   worker   119s   v1.26.2</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="6-3部署kube-proxy"><a href="#6-3部署kube-proxy" class="headerlink" title="6.3部署kube-proxy"></a>6.3部署kube-proxy</h2><p>kube-proxy运行在所有worker节点上，它监听apiserver中service和endpoint的变化情况，创建路由规则提供服务IP和负载均衡功能。</p>
<h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><p>kube-proxy提取证书中的CN作为客户端的用户名，即<code>system:kube-proxy</code>。 kube-apiserver预定义的 RBAC使用的ClusterRoleBindings <code>system:node-proxier</code>将用户<code>system:kube-proxy</code>与ClusterRole <code>system:node-proxier</code>绑定，该Role授予节点调用kube-apiserver proxy相关api的权限；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe clusterrolebinding/system:node-proxier</span><br><span class="line">Name:         system:node-proxier</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: true</span><br><span class="line">Role:</span><br><span class="line">  Kind:  ClusterRole</span><br><span class="line">  Name:  system:node-proxier</span><br><span class="line">Subjects:</span><br><span class="line">  Kind  Name               Namespace</span><br><span class="line">  ----  ----               ---------</span><br><span class="line">  User  system:kube-proxy</span><br></pre></td></tr></table></figure>



<p>生成脚本<code>gen_kube_proxy_cert.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt; kube-proxy_kubeconfig.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">K8S_CONF_DIR=/opt/k8s/config</span><br><span class="line"></span><br><span class="line">APISERVER_IP=$1</span><br><span class="line">K8S_CERT_DIR=$2</span><br><span class="line">PORT=6443</span><br><span class="line">CLUSTER_NAME=kubernetes</span><br><span class="line">KUBE_APISERVER=https://$&#123;APISERVER_IP&#125;:$&#123;PORT&#125;</span><br><span class="line">KUBECONFIG_FILE=kubeconfig/kube-proxy.kubeconfig</span><br><span class="line">USERNAME=system:kube-proxy</span><br><span class="line">CONTEXT_NAME=$&#123;USERNAME&#125;@$&#123;CLUSTER_NAME&#125;</span><br><span class="line">CERT_PRFIX=kube-proxy</span><br><span class="line"></span><br><span class="line">./bin/kubectl config set-cluster $&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --certificate-authority=$&#123;K8S_CERT_DIR&#125;/ca.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"></span><br><span class="line">./bin/kubectl config set-credentials $&#123;USERNAME&#125; \</span><br><span class="line">    --client-certificate=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;.pem \</span><br><span class="line">    --client-key=$&#123;K8S_CERT_DIR&#125;/$&#123;CERT_PRFIX&#125;-key.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"></span><br><span class="line">./bin/kubectl config set-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --cluster=$&#123;CLUSTER_NAME&#125; \</span><br><span class="line">    --user=$&#123;USERNAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line"></span><br><span class="line">./bin/kubectl config use-context $&#123;CONTEXT_NAME&#125; \</span><br><span class="line">    --kubeconfig=$&#123;KUBECONFIG_FILE&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -x kube-proxy_kubeconfig.sh 192.68.3.24 ssl</span><br></pre></td></tr></table></figure>



<p>生成配置文件和service文件，生成脚本<code>kube-proxy_config.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">clusterCIDR: 172.16.0.0/16	这个是pod网段</span></span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt; kube-proxy_config.sh</span><br><span class="line"></span><br><span class="line">K8S_CONF_DIR=/opt/k8s/config</span><br><span class="line">CLUSER_CIDR=172.16.0.0/16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 创建 kube-proxy 启动参数配置文件</span></span></span><br><span class="line">cat &gt; config/kube-proxy.yaml &lt;&lt;EOF1</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: $&#123;K8S_CONF_DIR&#125;/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: $&#123;CLUSER_CIDR&#125; </span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line">EOF1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">----------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 kube-proxy.service 服务管理文件</span></span><br><span class="line">cat &gt; service/kube-proxy.service &lt;&lt;EOF2</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">    --config=$&#123;K8S_CONF_DIR&#125;/kube-proxy.yaml \\</span><br><span class="line">    --v=2</span><br><span class="line">    </span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash -x kube-proxy_config.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在config目录下生成</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">├── kube-proxy.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在service目录下生成</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">├── kube-proxy.service</span></span><br></pre></td></tr></table></figure>



<p>分发二进制文件、配置文件、kubeconfig文件及service文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">scp bin/kube-proxy $i:/usr/local/bin/; \</span><br><span class="line">scp config/kube-proxy.yaml $i:/opt/k8s/config/; \</span><br><span class="line">scp kubeconfig/kube-proxy.kubeconfig $i:/opt/k8s/config/; \</span><br><span class="line">scp service/kube-proxy.service $i:/usr/lib/systemd/system/; \</span><br><span class="line">scp ssl/front-proxy-ca.pem $i:/opt/k8s/ssl/; \</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for i in k8s-01 k8s-02 k8s-03; do \</span><br><span class="line">ssh $i &quot;systemctl daemon-reload&quot;; \</span><br><span class="line">ssh $i &quot;systemctl enable kube-proxy&quot;; \</span><br><span class="line">ssh $i &quot;systemctl restart kube-proxy --no-block&quot;; \</span><br><span class="line">ssh $i &quot;systemctl is-active kube-proxy&quot;; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>





<h2 id="6-4部署calico"><a href="#6-4部署calico" class="headerlink" title="6.4部署calico"></a>6.4部署calico</h2><p>calico中，pod的网卡的另一端并不是接入虚拟网桥，而是直接接入了到内核中，所以看不到另外一端</p>
<p>组件</p>
<ul>
<li><p>Felix：运行于各个节点的守护进程，主要完成接口管理、路由规划、ACL规划、路由和ACL的报文状态</p>
</li>
<li><p>BIRD：vRouter的实现，默认是bgp客户端，在运行Felix的节点必须要运行BIRD；同时又是路由反射器</p>
<p>BGP协议的守护进程：既可以是路由反射器又是bgp客户端</p>
</li>
</ul>
<p>下载calico.yaml并修改配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/addons</span><br><span class="line">cd /root/addons/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装 Tigera Calico 操作员和自定义资源定义。</span></span><br><span class="line">kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/tigera-operator.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过创建必要的自定义资源来安装 Calico</span></span><br><span class="line">wget https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/custom-resources.yaml</span><br><span class="line"></span><br><span class="line">cat custom-resources.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This section includes base Calico installation configuration.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation</span></span><br><span class="line">apiVersion: operator.tigera.io/v1</span><br><span class="line">kind: Installation</span><br><span class="line">metadata:</span><br><span class="line">  name: default</span><br><span class="line">spec:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Configures Calico networking.</span></span><br><span class="line">  calicoNetwork:</span><br><span class="line">    ipPools:</span><br><span class="line">    - name: default-ipv4-ippool</span><br><span class="line">      blockSize: 26</span><br><span class="line">      cidr: 172.16.0.0/16</span><br><span class="line">      encapsulation: VXLANCrossSubnet</span><br><span class="line">      natOutgoing: Enabled</span><br><span class="line">      nodeSelector: all()</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This section configures the Calico API server.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer</span></span><br><span class="line">apiVersion: operator.tigera.io/v1</span><br><span class="line">kind: APIServer</span><br><span class="line">metadata:</span><br><span class="line">  name: default</span><br><span class="line">spec: &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="7部署addons"><a href="#7部署addons" class="headerlink" title="7部署addons"></a>7部署addons</h1><p>用于集群内部service的解析，可以让pod把service name解析成service ip，然后通过service的ip地址进行连接到对应的应用，打开<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns">传送门</a>，查看coredns的最新版本，目前最新是<code>1.10.0</code>版本。</p>
<p>生成yaml资源文件，创建脚本文件<code>gen_coredns_config.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">cat gen_coredns_config.sh</span><br><span class="line"></span><br><span class="line">DNS_DOMAIN=cluster.local</span><br><span class="line">IMAGE_REGISTRY=registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3</span><br><span class="line">DNS_MEMORY_LIMIT=170Mi</span><br><span class="line">DNS_SERVER_IP=10.96.0.10</span><br><span class="line"></span><br><span class="line">cat &gt; coredns.yaml &lt;&lt;EOF1</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - discovery.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - endpointslices</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health &#123;</span><br><span class="line">            lameduck 5s</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes $&#123;DNS_DOMAIN&#125; in-addr.arpa ip6.arpa &#123;</span><br><span class="line">            pods insecure</span><br><span class="line">            fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">            ttl 30</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        forward . /etc/resolv.conf &#123;</span><br><span class="line">            max_concurrent 1000</span><br><span class="line">        &#125;</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">replicas: not specified here:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">1. In order to make Addon Manager <span class="keyword">do</span> not reconcile this replicas parameter.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">2. Default is 1.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">3. Will be tuned <span class="keyword">in</span> real <span class="keyword">time</span> <span class="keyword">if</span> DNS horizontal auto-scaling is turned on.</span></span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">    spec:</span><br><span class="line">      securityContext:</span><br><span class="line">        seccompProfile:</span><br><span class="line">          type: RuntimeDefault</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - weight: 100</span><br><span class="line">            podAffinityTerm:</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: k8s-app</span><br><span class="line">                    operator: In</span><br><span class="line">                    values: [&quot;kube-dns&quot;]</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      tolerations:</span><br><span class="line">        - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">          operator: &quot;Exists&quot;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: $&#123;IMAGE_REGISTRY&#125;</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: $&#123;DNS_MEMORY_LIMIT&#125;</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        args: [ &quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot; ]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: 8181</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">            drop:</span><br><span class="line">            - all</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/port: &quot;9153&quot;</span><br><span class="line">    prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  clusterIP: $&#123;DNS_SERVER_IP&#125;</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br><span class="line">EOF1</span><br></pre></td></tr></table></figure>



<p>执行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash -x gen_coredns_config.sh</span><br><span class="line"></span><br><span class="line">kubectl apply -f coredns.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pod -A</span><br><span class="line">NAMESPACE          NAME                                       READY   STATUS             RESTARTS   AGE</span><br><span class="line">kube-system        coredns-c99df6f57-kvx6n                    1/1     Running            0          6h6m</span><br></pre></td></tr></table></figure>



<h1 id="8-部署metrics-server"><a href="#8-部署metrics-server" class="headerlink" title="8 部署metrics-server"></a>8 部署metrics-server</h1><p>在k8s中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和pod的内存，磁盘，CPU和网络使用率。可以<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server/releases">传送门</a>下载yaml文件，但是要修改几个参数:</p>
<p><code>IMAGE_REGISTRY</code>：在阿里云的容器服务里面查看对应metrics-server镜像的版本</p>
<h4 id="生成yaml资源文件"><a href="#生成yaml资源文件" class="headerlink" title="生成yaml资源文件"></a>生成yaml资源文件</h4><p>创建脚本文件<code>gen_metrics-server_config.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"> cat gen_metrics-server_config.sh</span><br><span class="line"></span><br><span class="line">CERT_PATH=/opt/k8s/ssl</span><br><span class="line">CLIENT_CA_FILE=$&#123;CERT_PATH&#125;/front-proxy-ca.pem</span><br><span class="line">IMAGE_REGISTRY=registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.1</span><br><span class="line"></span><br><span class="line">cat &gt; metrics-server.yaml &lt;&lt;EOF1</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">    rbac.authorization.k8s.io/aggregate-to-admin: &quot;true&quot;</span><br><span class="line">    rbac.authorization.k8s.io/aggregate-to-edit: &quot;true&quot;</span><br><span class="line">    rbac.authorization.k8s.io/aggregate-to-view: &quot;true&quot;</span><br><span class="line">  name: system:aggregated-metrics-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - metrics.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server-auth-reader</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: extension-apiserver-authentication-reader</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server:system:auth-delegator</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:auth-delegator</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:metrics-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: https</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls   # kubectl top nodes</span><br><span class="line">        - --requestheader-client-ca-file=$&#123;CLIENT_CA_FILE&#125;   # 聚合CA证书 front-proxy-ca.crt</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User</span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">        image: $&#123;IMAGE_REGISTRY&#125;</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /livez</span><br><span class="line">            port: https</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        name: metrics-server</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 4443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /readyz</span><br><span class="line">            port: https</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">          initialDelaySeconds: 20</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">          runAsNonRoot: true</span><br><span class="line">          runAsUser: 1000</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-dir</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: $&#123;CERT_PATH&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      hostNetwork: true	   # kubectl top pods</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: tmp-dir</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: $&#123;CERT_PATH&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apiregistration.k8s.io/v1</span><br><span class="line">kind: APIService</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: v1beta1.metrics.k8s.io</span><br><span class="line">spec:</span><br><span class="line">  group: metrics.k8s.io</span><br><span class="line">  groupPriorityMinimum: 100</span><br><span class="line">  insecureSkipTLSVerify: true</span><br><span class="line">  service:</span><br><span class="line">    name: metrics-server</span><br><span class="line">    namespace: kube-system</span><br><span class="line">  version: v1beta1</span><br><span class="line">  versionPriority: 100</span><br><span class="line">EOF1</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash -x gen_metrics-server_config.sh</span><br><span class="line"></span><br><span class="line">kubectl apply -f metrics-server.yaml</span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">NAME                             READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">coredns-c99df6f57-kvx6n          1/1     Running   0          6h9m</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">metrics-server-584554654-bwgwk   1/1     Running   0          6h7m</span></span><br></pre></td></tr></table></figure>





<h1 id="9-部署rancher"><a href="#9-部署rancher" class="headerlink" title="9 部署rancher"></a>9 部署rancher</h1><h2 id="9-1-安装helm"><a href="#9-1-安装helm" class="headerlink" title="9.1 安装helm"></a>9.1 安装helm</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</span><br><span class="line">bash get_helm.sh</span><br></pre></td></tr></table></figure>



<h2 id="9-2-使用helm安装依赖"><a href="#9-2-使用helm安装依赖" class="headerlink" title="9.2 使用helm安装依赖"></a>9.2 使用helm安装依赖</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span><br><span class="line">kubectl create namespace cattle-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装cert-manager</span></span><br><span class="line">helm repo add jetstack https://charts.jetstack.io</span><br><span class="line">helm repo update</span><br><span class="line">helm install cert-manager jetstack/cert-manager --create-namespace --namespace cert-manager --set installCRDs=true</span><br></pre></td></tr></table></figure>





<h2 id="9-3安装rancher"><a href="#9-3安装rancher" class="headerlink" title="9.3安装rancher"></a>9.3安装rancher</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install rancher rancher-latest/rancher --devel  --namespace cattle-system   --set hostname=rancher.fengzhigu.cloud   --set bootstrapPassword=admin --version 2.10.0</span><br></pre></td></tr></table></figure>



<p>rancher暂时不支持k8s v1.32.0</p>

                    
                        

    
    <div class="image-gallery">
        <div class="image-gallery-metabar">
            <span>Gallery: 4 images</span>
        </div>
        <div class="image-gallery-photos image-gallery-photos--thumbnail">
            
            
            <div class="photo-box">
                <a
                    class="photo-box-inner fancybox"
                    data-fancybox="gallery-cm4vgkg9m00000s66hhd3h22p"
                    data-caption="New York"
                    title="New York"
                    href="http://example.com/2024/12/19/Manually_deploy_k8s/image-3.jpg"
                    aria-label=""
                >
                    

                        <img
                                class="photo" src="http://example.com/2024/12/19/Manually_deploy_k8s/image-3.jpg"
                        >
                    
                </a>
            </div>
            
            
            <div class="photo-box">
                <a
                    class="photo-box-inner fancybox"
                    data-fancybox="gallery-cm4vgkg9m00000s66hhd3h22p"
                    data-caption="Paris"
                    title="Paris"
                    href="http://example.com/2024/12/19/Manually_deploy_k8s/image-4.png"
                    aria-label=""
                >
                    

                        <img
                                class="photo" src="http://example.com/2024/12/19/Manually_deploy_k8s/image-4.png"
                        >
                    
                </a>
            </div>
            
            
            <div class="photo-box">
                <a
                    class="photo-box-inner fancybox"
                    data-fancybox="gallery-cm4vgkg9m00000s66hhd3h22p"
                    data-caption="Dubai"
                    title="Dubai"
                    target="_blank" rel="noopener" href="http://i.imgur.com/o9r19kD.jpg"
                    aria-label=""
                >
                    

                        <img
                                class="photo" src="http://i.imgur.com/o9r19kD.jpg"
                        >
                    
                </a>
            </div>
            
            
            <div class="photo-box">
                <a
                    class="photo-box-inner fancybox"
                    data-fancybox="gallery-cm4vgkg9m00000s66hhd3h22p"
                    data-caption="Sidney"
                    title="Sidney"
                    href="https://example.com/orignal.jpg"
                    aria-label=""
                >
                    
                </a>
            </div>
            
        </div>
    </div>


                    
                    
                        <p>
                            <a
                                href="/2024/12/19/Manually_deploy_k8s/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
            <a
                href="/2024/12/19/Manually_deploy_k8s/"
                aria-label=": 手动部署k8s"
            >
                <div class="postShorten-thumbnailimg">
                    <img alt="" src="https://1416018124.github.io/2024/12/19/Manually_deploy_k8s/image-1.png"/>
                </div>
            </a>
            
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/12/18/hello-world/"
                            aria-label=": Hello World"
                        >
                            Hello World
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-12-18T23:55:07+08:00">
	
		    Dec 18, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/12/18/hello-world/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
            <a
                href="/2024/12/18/hello-world/"
                aria-label=": Hello World"
            >
                <div class="postShorten-thumbnailimg">
                    <img alt="" src=""/>
                </div>
            </a>
            
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 John Doe. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">John Doe</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-p2ssgnbftin4xedccxbuog4edl9jkt5x6ei7phvwevjlrkkr0xvvl08iwpyl.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
